<Window x:Class="IndiLogs_3._0.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:IndiLogs_3._0.ViewModels"
        xmlns:controls="clr-namespace:IndiLogs_3._0.Controls"
        xmlns:views="clr-namespace:IndiLogs_3._0.Views"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}" 
        Height="750" Width="1100" 
        Background="{DynamicResource BgDark}"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True" 
        Drop="Window_Drop">

    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <Style x:Key="CollapsibleSidebarStyle" TargetType="FrameworkElement">
            <Style.Triggers>
                <DataTrigger Binding="{Binding SelectedIndex, ElementName=MainTabs}" Value="3">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding SelectedIndex, ElementName=MainTabs}" Value="4">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Window.InputBindings>
        <KeyBinding Key="Space" Command="{Binding MarkRowCommand}" />
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoFilterOutCommand}" />
        <KeyBinding Key="OemPlus" Modifiers="Ctrl" Command="{Binding ZoomInCommand}" />
        <KeyBinding Key="Add" Modifiers="Ctrl" Command="{Binding ZoomInCommand}" />
        <KeyBinding Key="OemMinus" Modifiers="Ctrl" Command="{Binding ZoomOutCommand}" />
        <KeyBinding Key="Subtract" Modifiers="Ctrl" Command="{Binding ZoomOutCommand}" />
        <KeyBinding Key="F" Modifiers="Ctrl" Command="{Binding ToggleSearchCommand}" />
        <KeyBinding Key="Esc" Command="{Binding CloseSearchCommand}" />
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="55"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="28"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="{DynamicResource BgPanel}" BorderBrush="{DynamicResource BorderColor}" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="10,0,20,0">
                    <Button Command="{Binding OpenSettingsCommand}" 
                            CommandParameter="{Binding RelativeSource={RelativeSource Self}}"
                            Style="{DynamicResource ModernBtn}" 
                            Width="40" Height="30" ToolTip="Settings" Margin="0,0,15,0" Padding="0">
                        <Button.Content>
                            <TextBlock Text="⚙" FontFamily="Segoe UI Symbol" FontSize="16" 
                                       VerticalAlignment="Center" HorizontalAlignment="Center"
                                       Foreground="{DynamicResource TextPrimary}"/>
                        </Button.Content>
                    </Button>
                    <TextBlock Text="IndiLogs" FontWeight="Bold" FontSize="18" Foreground="{DynamicResource TextPrimary}" VerticalAlignment="Center"/>
                    <TextBlock Text="3.0" FontWeight="Light" FontSize="18" Foreground="{DynamicResource PrimaryColor}" VerticalAlignment="Center" Margin="4,0,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Command="{Binding LoadCommand}" Style="{DynamicResource PrimaryBtn}" 
                            ToolTip="Load Files... (Drag &amp; Drop supported)" Width="50" Height="35">
                        <TextBlock Text="📂" FontSize="18" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White"/>
                    </Button>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Button Command="{Binding MarkRowCommand}" Style="{DynamicResource ModernBtn}" ToolTip="Mark Row (Space)" Width="45" Padding="5">
                        <Rectangle Width="20" Height="20" Fill="{DynamicResource TextPrimary}">
                            <Rectangle.OpacityMask>
                                <ImageBrush ImageSource="/Resources/mark.ico" Stretch="Uniform"/>
                            </Rectangle.OpacityMask>
                        </Rectangle>
                    </Button>
                    <Button Content="⬇" Command="{Binding NextMarkedCommand}" Style="{DynamicResource ModernBtn}" ToolTip="Next Marked" Width="45" FontSize="16"/>
                    <Button Content="⬆" Command="{Binding PrevMarkedCommand}" Style="{DynamicResource ModernBtn}" ToolTip="Previous Marked" Width="45" FontSize="16"/>
                </StackPanel>

                <StackPanel Grid.Column="3" Orientation="Horizontal" Margin="0,0,10,0">
                    <StackPanel Orientation="Horizontal" Margin="0,0,20,0" 
                                Visibility="{Binding IsLiveMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Button Command="{Binding LivePlayCommand}" 
                                Visibility="{Binding IsPaused, Converter={StaticResource BooleanToVisibilityConverter}}"
                                Style="{DynamicResource ModernBtn}" ToolTip="Resume Live Monitoring" Padding="5" Background="#10B981" Foreground="White">
                            <TextBlock Text="▶ Play" FontWeight="Bold"/>
                        </Button>
                        <Button Command="{Binding LivePauseCommand}" 
                                Visibility="{Binding IsRunning, Converter={StaticResource BooleanToVisibilityConverter}}"
                                Style="{DynamicResource ModernBtn}" ToolTip="Pause Live Monitoring" Padding="5" Background="#F59E0B" Foreground="White">
                            <TextBlock Text="⏸ Pause" FontWeight="Bold"/>
                        </Button>
                        <Button Command="{Binding LiveClearCommand}" Style="{DynamicResource ModernBtn}" ToolTip="Clear &amp; Skip Old Logs" Padding="5" Background="#EF4444" Foreground="White" Margin="5,3,0,3">
                            <TextBlock Text="⊘ Clear" FontWeight="Bold"/>
                        </Button>
                        <Rectangle Width="1" Fill="{DynamicResource BorderColor}" Margin="10,5"/>
                    </StackPanel>
                    <Button Command="{Binding OpenGraphViewerCommand}" Style="{DynamicResource ModernBtn}" ToolTip="Open Graph Viewer" Padding="5">
                        <TextBlock Text="📈" FontSize="18" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="{DynamicResource TextPrimary}"/>
                    </Button>
                    <Button Command="{Binding OpenJiraCommand}" Style="{DynamicResource ModernBtn}" ToolTip="Open JIRA" Padding="5">
                        <Rectangle Width="20" Height="20" Fill="{DynamicResource TextPrimary}">
                            <Rectangle.OpacityMask>
                                <ImageBrush ImageSource="/Resources/jira.ico" Stretch="Uniform"/>
                            </Rectangle.OpacityMask>
                        </Rectangle>
                    </Button>
                    <Button Command="{Binding OpenKibanaCommand}" Style="{DynamicResource ModernBtn}" ToolTip="Open Kibana" Padding="5">
                        <Image Source="/Resources/kibana.ico" Width="24" Height="24" RenderOptions.BitmapScalingMode="HighQuality"/>
                    </Button>
                    <Button Command="{Binding OpenOutlookCommand}" Style="{DynamicResource ModernBtn}" ToolTip="Send Email" Padding="5">
                        <Rectangle Width="20" Height="20" Fill="{DynamicResource TextPrimary}">
                            <Rectangle.OpacityMask>
                                <ImageBrush ImageSource="/Resources/outlook.ico" Stretch="Uniform"/>
                            </Rectangle.OpacityMask>
                        </Rectangle>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0" Width="280" Style="{StaticResource CollapsibleSidebarStyle}">
                <TabControl Background="{DynamicResource BgPanel}" BorderThickness="0,0,1,0" Margin="0" Padding="0" SelectedIndex="{Binding LeftTabIndex}">
                    <TabControl.Resources>
                        <Style TargetType="TabItem">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="{DynamicResource TextSecondary}"/>
                            <Setter Property="FontSize" Value="12"/>
                            <Setter Property="FontWeight" Value="SemiBold"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabItem">
                                        <Border Name="Border" BorderThickness="0,0,0,2" BorderBrush="Transparent" Padding="10,6" Cursor="Hand">
                                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource PrimaryColor}"/>
                                                <Setter Property="Foreground" Value="{DynamicResource PrimaryColor}"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </TabControl.Resources>

                    <TabItem Header="EXPLORER">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Text="SESSIONS" Foreground="{DynamicResource TextSecondary}" FontWeight="Bold" FontSize="11" Margin="10,10,0,5"/>

                            <ListBox Grid.Row="1" 
                                     ItemsSource="{Binding LoadedSessions}" 
                                     SelectedItem="{Binding SelectedSession, Mode=TwoWay}"
                                     Background="Transparent" BorderThickness="0" 
                                     Foreground="{DynamicResource TextPrimary}"
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,4">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="📄" Margin="0,0,6,0" Foreground="{DynamicResource TextSecondary}" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1" Text="{Binding FileName}" ToolTip="{Binding FilePath}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem">
                                        <Setter Property="Padding" Value="8,4"/>
                                        <Setter Property="Cursor" Value="Hand"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ListBoxItem">
                                                    <Border Name="Border" Background="Transparent" CornerRadius="4" Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="Border" Property="Background" Value="#3E3E42"/>
                                                        </Trigger>
                                                        <Trigger Property="IsSelected" Value="True">
                                                            <Setter TargetName="Border" Property="Background" Value="{DynamicResource PrimaryColor}"/>
                                                            <Setter Property="Foreground" Value="White"/>
                                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ListBox.ItemContainerStyle>
                            </ListBox>

                            <StackPanel Grid.Row="2" Orientation="Vertical" Margin="10">
                                <Button Content="🗑 Clear All" Command="{Binding ClearCommand}" Background="{DynamicResource DangerColor}" Style="{DynamicResource PrimaryBtn}" Margin="0,0,0,5"/>
                                <Button Content="📌 Marked Lines" Command="{Binding OpenMarkedLogsWindowCommand}" Style="{DynamicResource ModernBtn}" Background="{DynamicResource BgCard}" Margin="0,0,0,5"/>
                                <Button Content="🔄 States" Command="{Binding OpenStatesWindowCommand}" Style="{DynamicResource ModernBtn}" Background="{DynamicResource BgCard}" Margin="0,0,0,5"/>
                                <Button Content="📊 Export CSV" Command="{Binding ExportParsedDataCommand}" Style="{DynamicResource ModernBtn}" Background="{DynamicResource BgCard}" Margin="0,0,0,5" ToolTip="Parse CH, IO, and Motor data to CSV"/>
                                <Button Content="⚙ Analyze" Command="{Binding RunAnalysisCommand}" Style="{DynamicResource ModernBtn}" Background="{DynamicResource BgCard}" ToolTip="Run Process Analysis"/>
                            </StackPanel>
                        </Grid>
                    </TabItem>

                    <TabItem Header="LOGGERS">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TreeView Grid.Row="0" ItemsSource="{Binding LoggerTreeRoot}" 
                                      Background="Transparent" 
                                      BorderThickness="0" 
                                      Padding="5"
                                      Foreground="{DynamicResource TextPrimary}">
                                <TreeView.ItemContainerStyle>
                                    <Style TargetType="TreeViewItem">
                                        <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                        <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                                        <EventSetter Event="PreviewMouseRightButtonDown" Handler="TreeViewItem_PreviewMouseRightButtonDown"/>
                                        <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                                        <Setter Property="ContextMenu">
                                            <Setter.Value>
                                                <ContextMenu>
                                                    <MenuItem Header="🎯 Show Only This" Command="{Binding PlacementTarget.Tag.TreeShowOnlyThisCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}"/>
                                                    <MenuItem Header="📂 Show With Children" Command="{Binding PlacementTarget.Tag.TreeShowWithChildrenCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}"/>
                                                    <Separator/>
                                                    <MenuItem Header="🚫 Hide This Logger" Command="{Binding PlacementTarget.Tag.TreeHideThisCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}"/>
                                                    <MenuItem Header="🚫 Hide With Children" Command="{Binding PlacementTarget.Tag.TreeHideWithChildrenCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}"/>
                                                    <Separator/>
                                                    <MenuItem Header="✅ Show All" Command="{Binding PlacementTarget.Tag.TreeShowAllCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                </ContextMenu>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </TreeView.ItemContainerStyle>
                                <TreeView.ItemTemplate>
                                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding Count, StringFormat=' ({0})'}" Foreground="{DynamicResource TextSecondary}" Margin="5,0,0,0"/>
                                        </StackPanel>
                                        <HierarchicalDataTemplate.Triggers>
                                            <DataTrigger Binding="{Binding IsHidden}" Value="True">
                                                <Setter Property="TextBlock.TextDecorations" Value="Strikethrough"/>
                                                <Setter Property="TextBlock.Foreground" Value="#EF4444"/>
                                            </DataTrigger>
                                        </HierarchicalDataTemplate.Triggers>
                                    </HierarchicalDataTemplate>
                                </TreeView.ItemTemplate>
                            </TreeView>
                            <StackPanel Grid.Row="1" Orientation="Vertical" Margin="10">
                                <Button Content="📌 Marked Lines" Command="{Binding OpenMarkedLogsWindowCommand}" Style="{DynamicResource ModernBtn}" Background="{DynamicResource BgCard}" Margin="0,0,0,5"/>
                            </StackPanel>
                        </Grid>
                    </TabItem>
                </TabControl>
            </Grid>

            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="Transparent" ShowsPreview="True" Style="{StaticResource CollapsibleSidebarStyle}"/>

            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="0,5,25,0" Panel.ZIndex="100"
                        Background="{DynamicResource BgCard}" BorderBrush="{DynamicResource PrimaryColor}" BorderThickness="1"
                        CornerRadius="4" Padding="5"
                        Visibility="{Binding IsSearchPanelVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Find:" VerticalAlignment="Center" Margin="5,0,5,0" Foreground="{DynamicResource TextPrimary}"/>
                        <TextBox x:Name="SearchTextBox" 
                                 Width="200" 
                                 Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                                 Background="{DynamicResource BgDark}" Foreground="{DynamicResource TextPrimary}" 
                                 BorderBrush="{DynamicResource BorderColor}"
                                 Padding="2" VerticalContentAlignment="Center"
                                 IsVisibleChanged="SearchTextBox_IsVisibleChanged"/>
                        <Button Content="✕" Command="{Binding CloseSearchCommand}" 
                                Style="{DynamicResource ModernBtn}" Width="25" Height="25" Padding="0" Margin="5,0,0,0"
                                ToolTip="Close (Esc)"/>
                    </StackPanel>
                </Border>

                <TabControl x:Name="MainTabs" Grid.Row="0" SelectedIndex="{Binding SelectedTabIndex}" BorderThickness="0" Background="Transparent" Margin="0,5,0,0">
                    <TabItem Header="PLC">
                        <DataGrid x:Name="MainLogsGrid" ItemsSource="{Binding Logs}" SelectedItem="{Binding SelectedLog}" 
                                  FontSize="{Binding GridFontSize}" 
                                  FontFamily="{DynamicResource ContentFontFamily}"
                                  FontWeight="{DynamicResource ContentFontWeight}"
                                  AutoGenerateColumns="False" IsReadOnly="True" 
                                  RowStyle="{DynamicResource LogRowStyle}" 
                                  SelectionMode="Extended"
                                  SelectionUnit="FullRow"
                                  PreviewKeyDown="MainLogsGrid_PreviewKeyDown">
                            <DataGrid.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Command="{Binding PlacementTarget.DataContext.FilterContextCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" Header="Time Focus Filter"/>
                                    <Separator/>
                                    <MenuItem Header="Filter Out (Message)..." Command="{Binding FilterOutCommand}"/>
                                    <MenuItem Header="Filter Out (Thread)..." Command="{Binding FilterOutThreadCommand}"/>
                                </ContextMenu>
                            </DataGrid.ContextMenu>
                            <DataGrid.InputBindings>
                                <KeyBinding Key="Space" Command="{Binding MarkRowCommand}" />
                                <MouseBinding Gesture="LeftDoubleClick" Command="{Binding ViewLogDetailsCommand}" CommandParameter="{Binding SelectedLog}" />
                            </DataGrid.InputBindings>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Lvl" Binding="{Binding Level}" Width="45" FontWeight="Bold"/>
                                <DataGridTextColumn Header="Time" Binding="{Binding Date, StringFormat='yyyy-MM-dd HH:mm:ss.fff'}" Width="160"/>
                                <DataGridTextColumn Binding="{Binding ThreadName}" Width="110">
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="Thread" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                                <Button Content="▼" Command="{Binding DataContext.OpenThreadFilterCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        Width="18" Height="18" Padding="0" FontSize="10" 
                                                        Background="Transparent" BorderThickness="0" Foreground="{DynamicResource TextSecondary}"
                                                        ToolTip="Filter by Thread"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>
                                <DataGridTemplateColumn Header="Message" Width="*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <controls:HighlightTextBlock 
                                                Text="{Binding Message}" 
                                                HighlightText="{Binding DataContext.SearchText, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                TextTrimming="CharacterEllipsis" 
                                                VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>

                    <TabItem Header="PLC (Filtered)">
                        <DataGrid ItemsSource="{Binding FilteredLogs}" SelectedItem="{Binding SelectedLog}" 
                                  FontSize="{Binding GridFontSize}" 
                                  FontFamily="{DynamicResource ContentFontFamily}"
                                  FontWeight="{DynamicResource ContentFontWeight}"
                                  AutoGenerateColumns="False" IsReadOnly="True" 
                                  RowStyle="{DynamicResource LogRowStyle}"
                                  SelectionMode="Extended"
                                  SelectionUnit="FullRow">
                            <DataGrid.InputBindings>
                                <MouseBinding Gesture="LeftDoubleClick" Command="{Binding ViewLogDetailsCommand}" CommandParameter="{Binding SelectedLog}" />
                            </DataGrid.InputBindings>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Lvl" Binding="{Binding Level}" Width="45" FontWeight="Bold"/>
                                <DataGridTextColumn Header="Time" Binding="{Binding Date, StringFormat='yyyy-MM-dd HH:mm:ss.fff'}" Width="160"/>
                                <DataGridTextColumn Header="Thread" Binding="{Binding ThreadName}" Width="90"/>
                                <DataGridTemplateColumn Header="Message" Width="*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <controls:HighlightTextBlock 
                                                Text="{Binding Message}" 
                                                HighlightText="{Binding DataContext.SearchText, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                TextTrimming="CharacterEllipsis" 
                                                VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>

                    <TabItem Header="APP">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <Border Grid.Row="0" Background="{DynamicResource BgCard}" Padding="5">
                                <StackPanel Orientation="Horizontal">
                                    <Button Command="{Binding FilterAppErrorsCommand}" 
                                            Style="{DynamicResource ModernBtn}" 
                                            Background="#EF4444" Foreground="White" 
                                            Padding="8,4" Margin="5" ToolTip="Show Errors Only (Newest First)">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="⚠" Margin="0,0,5,0"/>
                                            <TextBlock Text="ERRORS" FontWeight="Bold"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Border>

                            <DataGrid Grid.Row="1" x:Name="AppLogsGrid" 
                                      ItemsSource="{Binding AppDevLogsFiltered}" 
                                      SelectedItem="{Binding SelectedLog}"
                                      Sorting="AppLogsGrid_Sorting"
                                      FontSize="{Binding GridFontSize}" 
                                      FontFamily="{DynamicResource ContentFontFamily}"
                                      FontWeight="{DynamicResource ContentFontWeight}"
                                      AutoGenerateColumns="False" IsReadOnly="True" 
                                      RowStyle="{DynamicResource LogRowStyle}" 
                                      SelectionMode="Extended" SelectionUnit="FullRow">

                                <DataGrid.InputBindings>
                                    <KeyBinding Key="Space" Command="{Binding MarkRowCommand}" />
                                    <MouseBinding Gesture="LeftDoubleClick" Command="{Binding ViewLogDetailsCommand}" CommandParameter="{Binding SelectedLog}" />
                                </DataGrid.InputBindings>

                                <DataGrid.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Command="{Binding PlacementTarget.DataContext.FilterContextCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" Header="Time Focus Filter"/>
                                        <Separator/>
                                        <MenuItem Header="Filter Out (Message)..." Command="{Binding FilterOutCommand}"/>
                                    </ContextMenu>
                                </DataGrid.ContextMenu>

                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Lvl" Binding="{Binding Level}" Width="50" FontWeight="Bold" CanUserSort="True" SortMemberPath="Level"/>
                                    <DataGridTextColumn Header="Time" Binding="{Binding Date, StringFormat='yyyy-MM-dd HH:mm:ss.fff'}" Width="160" CanUserSort="True" SortMemberPath="Time"/>
                                    <DataGridTextColumn Header="Logger" Binding="{Binding Logger}" Width="250" CanUserSort="True" SortMemberPath="Logger"/>
                                    <DataGridTextColumn Header="Thread" Binding="{Binding ThreadName}" Width="80" CanUserSort="True" SortMemberPath="Thread"/>

                                    <DataGridTemplateColumn Header="Message" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <controls:HighlightTextBlock 
                                                    Text="{Binding Message}" 
                                                    HighlightText="{Binding DataContext.SearchText, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                    TextTrimming="CharacterEllipsis" 
                                                    VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Graphs">
                        <views:GraphsView DataContext="{Binding GraphsVM}"/>
                    </TabItem>

                    <TabItem Header="Events">
                        <DataGrid ItemsSource="{Binding Events}" 
                                  FontSize="{Binding GridFontSize}" 
                                  FontFamily="{DynamicResource ContentFontFamily}"
                                  FontWeight="{DynamicResource ContentFontWeight}"
                                  AutoGenerateColumns="False" 
                                  IsReadOnly="True" 
                                  RowStyle="{DynamicResource LogRowStyle}" 
                                  CanUserAddRows="False"
                                  VerticalScrollBarVisibility="Auto">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Time" Binding="{Binding Time, StringFormat='yyyy-MM-dd HH:mm:ss.fff'}" Width="180"/>
                                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="200"/>
                                <DataGridTextColumn Header="State" Binding="{Binding State}" Width="120"/>
                                <DataGridTextColumn Header="Severity" Binding="{Binding Severity}" Width="80"/>

                                <DataGridTextColumn Header="Parameters" Binding="{Binding Parameters}" Width="200">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                            <Setter Property="ToolTip" Value="{Binding Parameters}"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Info" Binding="{Binding Description}" Width="*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>

                    <TabItem Header="Screenshots">
                        <Grid Background="#111" ClipToBounds="True">
                            <ScrollViewer x:Name="ScreenshotScrollViewer"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Auto"
                                          PanningMode="Both"
                                          Cursor="SizeAll"
                                          PreviewMouseLeftButtonDown="OnImageMouseLeftButtonDown"
                                          PreviewMouseLeftButtonUp="OnImageMouseLeftButtonUp"
                                          PreviewMouseMove="OnImageMouseMove"
                                          PreviewMouseWheel="OnScreenshotMouseWheel">
                                <ItemsControl ItemsSource="{Binding Screenshots}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Image Source="{Binding}" Margin="10" 
                                                   Width="{Binding DataContext.ScreenshotZoom, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                   Stretch="Uniform"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Press Config">
                        <TextBox Text="{Binding PressConfig}" IsReadOnly="True" 
                                 FontFamily="{DynamicResource ContentFontFamily}"
                                 FontWeight="{DynamicResource ContentFontWeight}"
                                 Background="{DynamicResource BgDark}" Foreground="{DynamicResource TextPrimary}" BorderThickness="0" VerticalScrollBarVisibility="Auto"/>
                    </TabItem>

                    <TabItem Header="Setup Info">
                        <TextBox Text="{Binding SetupInfo}" IsReadOnly="True" 
                                 FontFamily="{DynamicResource ContentFontFamily}"
                                 FontWeight="{DynamicResource ContentFontWeight}"
                                 Background="{DynamicResource BgDark}" Foreground="{DynamicResource TextPrimary}" BorderThickness="0" VerticalScrollBarVisibility="Auto"/>
                    </TabItem>
                </TabControl>

                <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Center" Background="#333" ShowsPreview="True">
                    <GridSplitter.Style>
                        <Style TargetType="GridSplitter">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedIndex, ElementName=MainTabs}" Value="3">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedIndex, ElementName=MainTabs}" Value="4">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </GridSplitter.Style>
                </GridSplitter>

                <Border Grid.Row="2" Background="{DynamicResource BgCard}" BorderBrush="{DynamicResource BorderColor}" BorderThickness="0,1,0,0">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedIndex, ElementName=MainTabs}" Value="3">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedIndex, ElementName=MainTabs}" Value="4">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="120"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" Background="{DynamicResource BgPanel}">
                            <Border Background="{DynamicResource BgCard}" BorderThickness="0,2,0,0" BorderBrush="#FFD700" Padding="15,4">
                                <TextBlock Text="Message Details" FontWeight="Bold" FontSize="12" Foreground="{DynamicResource TextPrimary}"/>
                            </Border>
                        </StackPanel>

                        <Grid Grid.Row="1" Margin="5,5,5,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="160"/>
                                <ColumnDefinition Width="20"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="80"/>
                                <ColumnDefinition Width="20"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" Text="Time:" Foreground="{DynamicResource TextSecondary}" Margin="0,0,5,0"/>
                            <TextBlock Grid.Column="1" Text="{Binding SelectedLog.Date, StringFormat='yyyy-MM-dd HH:mm:ss.fff'}" Foreground="{DynamicResource TextPrimary}" FontWeight="SemiBold"/>

                            <TextBlock Grid.Column="3" Text="Level:" Foreground="{DynamicResource TextSecondary}" Margin="0,0,5,0"/>
                            <TextBlock Grid.Column="4" Text="{Binding SelectedLog.Level}" Foreground="{DynamicResource TextPrimary}" FontWeight="Bold"/>

                            <TextBlock Grid.Column="6" Text="Logger:" Foreground="{DynamicResource TextSecondary}" Margin="0,0,5,0"/>
                            <TextBlock Grid.Column="7" Text="{Binding SelectedLog.Logger}" Foreground="{DynamicResource TextPrimary}" TextTrimming="CharacterEllipsis"/>
                        </Grid>

                        <TextBox Grid.Row="2"
                                 Text="{Binding SelectedLog.Message, Mode=OneWay}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Auto"
                                 HorizontalScrollBarVisibility="Auto"
                                 AcceptsReturn="True"
                                 FontFamily="Consolas"
                                 FontSize="13"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 Padding="5"
                                 Margin="0,5,0,0"
                                 Foreground="{DynamicResource TextPrimary}"/>
                    </Grid>
                </Border>

                <Border Grid.Row="3" Background="{DynamicResource BgCard}" BorderBrush="{DynamicResource BorderColor}" BorderThickness="0,1,0,0" Padding="10,5">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedIndex, ElementName=MainTabs}" Value="3">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding SelectedIndex, ElementName=MainTabs}" Value="4">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                            <Button Content="🔍 Filter..." Command="{Binding OpenFilterWindowCommand}" Style="{DynamicResource ModernBtn}" Background="{DynamicResource BgPanel}"/>
                            <Button Content="🎨 Color..." Command="{Binding OpenColoringWindowCommand}" Style="{DynamicResource ModernBtn}" Background="{DynamicResource BgPanel}"/>
                            <CheckBox Content="FILTER OUT" IsChecked="{Binding IsFilterOutActive}" ToolTip="Uncheck to reveal hidden logs" VerticalAlignment="Center" VerticalContentAlignment="Center" Margin="10,0,15,0" Foreground="{DynamicResource TextPrimary}"/>
                            <CheckBox Content="FILTER" IsChecked="{Binding IsFilterActive}" VerticalAlignment="Center" VerticalContentAlignment="Center" Foreground="{DynamicResource TextPrimary}"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <GridSplitter Grid.Column="3" Width="5" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="Transparent" ShowsPreview="True" Style="{StaticResource CollapsibleSidebarStyle}"/>

            <Border Grid.Column="4" Width="220" Background="{DynamicResource BgPanel}" BorderBrush="{DynamicResource BorderColor}" BorderThickness="1,0,0,0" Padding="10" Style="{StaticResource CollapsibleSidebarStyle}">
                <DockPanel>
                    <TextBlock Text="CONFIGS" Foreground="{DynamicResource TextSecondary}" FontWeight="Bold" FontSize="11" Margin="0,0,0,10" DockPanel.Dock="Top"/>

                    <StackPanel DockPanel.Dock="Bottom" Margin="0,10,0,0">
                        <Button Content="💾 Save" Command="{Binding SaveConfigCommand}" Style="{DynamicResource ModernBtn}" Background="#10B981" Foreground="White"/>
                        <Button Content="📂 Load" Command="{Binding LoadConfigCommand}" Style="{DynamicResource ModernBtn}"/>
                        <Button Content="🗑 Delete" Command="{Binding RemoveConfigCommand}" Style="{DynamicResource ModernBtn}" Foreground="#EF4444"/>
                    </StackPanel>

                    <ListView ItemsSource="{Binding SavedConfigs}" 
                              SelectedItem="{Binding SelectedConfig, Mode=TwoWay}"
                              Background="Transparent" 
                              BorderThickness="0" 
                              Foreground="{DynamicResource TextPrimary}"
                              HorizontalContentAlignment="Stretch">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,2" Background="Transparent">
                                    <Grid.InputBindings>
                                        <MouseBinding Gesture="LeftDoubleClick" Command="{Binding DataContext.ApplyConfigCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}"/>
                                    </Grid.InputBindings>
                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </DockPanel>
            </Border>
        </Grid>

        <Border Grid.Row="2" Background="{DynamicResource PrimaryColor}" Padding="10,0">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{Binding Logs.Count, StringFormat='Logs: {0:N0}'}" Foreground="White" VerticalAlignment="Center" FontWeight="SemiBold" Margin="0,0,15,0"/>
                    <TextBlock Text="{Binding Events.Count, StringFormat='Events: {0:N0}'}" Foreground="White" VerticalAlignment="Center" FontWeight="SemiBold"/>

                    <TextBlock Text=" | " Foreground="#F59E0B" VerticalAlignment="Center" Margin="10,0,0,0"
                               Visibility="{Binding IsFilterActive, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <TextBlock Text="FILTER ON" Foreground="#F59E0B" VerticalAlignment="Center" FontWeight="Bold" 
                               Visibility="{Binding IsFilterActive, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                    <TextBlock Text=" | " Foreground="{DynamicResource DangerColor}" VerticalAlignment="Center" Margin="10,0,0,0"
                               Visibility="{Binding IsFilterOutActive, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <TextBlock Text="FILTER OUT ON" Foreground="{DynamicResource DangerColor}" VerticalAlignment="Center" FontWeight="Bold" 
                               Visibility="{Binding IsFilterOutActive, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </StackPanel>
                <TextBlock Text="{Binding StatusMessage}" Foreground="White" HorizontalAlignment="Right" VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <Grid Grid.RowSpan="3" Background="#CC000000" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}" Panel.ZIndex="999">
            <Border Background="{DynamicResource BgCard}" 
                    BorderBrush="{DynamicResource PrimaryColor}" 
                    BorderThickness="1" 
                    CornerRadius="15" 
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Center" 
                    Width="450" 
                    Height="320"
                    MaxWidth="450"
                    MaxHeight="320"
                    Effect="{DynamicResource ShadowEffect}">

                <Border.Resources>
                    <DropShadowEffect x:Key="ShadowEffect" BlurRadius="25" ShadowDepth="0" Opacity="0.6" Color="Black"/>
                </Border.Resources>

                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="80"/>
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" Width="130" Height="130" VerticalAlignment="Center" HorizontalAlignment="Center">
                        <Ellipse Stroke="{DynamicResource BorderColor}" StrokeThickness="10" Width="130" Height="130"/>
                        <Path Stroke="{DynamicResource PrimaryColor}" StrokeThickness="10" StrokeStartLineCap="Round" StrokeEndLineCap="Round"
                              Data="M 65,0 A 65,65 0 0 1 130,65" RenderTransformOrigin="0.5,0.5">
                            <Path.RenderTransform>
                                <RotateTransform Angle="0"/>
                            </Path.RenderTransform>
                            <Path.Triggers>
                                <EventTrigger RoutedEvent="Loaded">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                             From="0" To="360" Duration="0:0:1.2" RepeatBehavior="Forever"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                            </Path.Triggers>
                        </Path>
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <TextBlock Text="{Binding CurrentProgress, StringFormat='{}{0:0}%'}" 
                                       FontSize="32" FontWeight="Bold" Foreground="{DynamicResource TextPrimary}" 
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>

                    <TextBlock Grid.Row="1" 
                               Text="{Binding StatusMessage}" 
                               FontSize="15" 
                               Foreground="{DynamicResource TextSecondary}" 
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Top" 
                               TextAlignment="Center" 
                               TextWrapping="Wrap" 
                               TextTrimming="CharacterEllipsis"
                               MaxHeight="75"
                               Margin="0,15,0,0"/>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>